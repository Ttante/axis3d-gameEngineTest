<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/camera.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/camera.js~CameraCommand.html">CameraCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/command.js~CommandContext.html">CommandContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controller.js~ControllerCommand.html">ControllerCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/feedback.js~FeedbackCommand.html">FeedbackCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/frame.js~FrameCommand.html">FrameCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fullscreen.js~FullscreenCommand.html">FullscreenCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry.js~Geometry.html">Geometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/media.js~MediaCommand.html">MediaCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh.js~MeshCommand.html">MeshCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_FAR">DEFAULT_CAMERA_FAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_FIELD_OF_VIEW">DEFAULT_CAMERA_FIELD_OF_VIEW</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_NEAR">DEFAULT_CAMERA_NEAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_ORIENTATION_ORIGIN">DEFAULT_CAMERA_ORIENTATION_ORIGIN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-encode">encode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_FRAGMENT_SHADER">DEFAULT_FRAGMENT_SHADER</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_VERTEX_SHADER">DEFAULT_VERTEX_SHADER</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$ctx">$ctx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$current">$current</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$domElement">$domElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$hasFocus">$hasFocus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$previous">$previous</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$ref">$ref</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$regl">$regl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$reglContext">$reglContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$run">$run</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$stack">$stack</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$state">$state</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-debug">debug</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-define">define</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getScreenOrientation">getScreenOrientation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isDOMElementInViewport">isDOMElementInViewport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-lerp">lerp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-radians">radians</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controls/ambisonic-audio</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controls/ambisonic-audio/index.js~AmbisonicAudioControllerCommand.html">AmbisonicAudioControllerCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controls/first-person-camera</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controls/first-person-camera/index.js~FirstPersonCameraController.html">FirstPersonCameraController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controls/orbit-camera</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controls/orbit-camera/index.js~OrbitCameraController.html">OrbitCameraController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_FRICTION">DEFAULT_FRICTION</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">geometry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/box.js~BoxGeometry.html">BoxGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/plane.js~PlaneGeometry.html">PlaneGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/sphere.js~SphereGeometry.html">SphereGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/triangle.js~TriangleGeometry.html">TriangleGeometry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">input</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/keyboard.js~KeyboardCommand.html">KeyboardCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/mouse.js~MouseCommand.html">MouseCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/orientation.js~OrientationCommand.html">OrientationCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/touch.js~TouchCommand.html">TouchCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">math</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/quaternion.js~Quaternion.html">Quaternion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/vector.js~Vector.html">Vector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-XVector3">XVector3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-YVector3">YVector3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ZVector3">ZVector3</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">media</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/media/audio.js~AudioCommand.html">AudioCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/media/image.js~ImageCommand.html">ImageCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/media/video.js~VideoCommand.html">VideoCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">mesh</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh/box.js~BoxCommand.html">BoxCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh/plane.js~PlaneCommand.html">PlaneCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh/sphere.js~SphereCommand.html">SphereCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh/triangle.js~TriangleCommand.html">TriangleCommand</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/camera.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

/**
 * Module dependencies.
 */

import { define, radians } from &apos;./utils&apos;
import { MeshCommand } from &apos;./mesh&apos;
import { Vector } from &apos;./math&apos;
import coalesce from &apos;defined&apos;
import mat4 from &apos;gl-mat4&apos;
import vec3 from &apos;gl-vec3&apos;
import quat from &apos;gl-quat&apos;

/**
 * CameraCommand constructor.
 * @see CameraCommand
 */

export default (...args) =&gt; new CameraCommand(...args)

/**
 * Scratch matrix
 *
 * @private
 * @const
 * @type {mat4}
 */

const scratch = mat4.identity([])

/**
 * Euler angle of the origin camera orientation
 * express in radians.
 *
 * @public
 * @const
 * @type {Vector}
 */

export const DEFAULT_CAMERA_ORIENTATION_ORIGIN =
  // pitch, yaw, roll
  new Vector(radians(90), 0, 0)

/**
 * Default field of view frustrum angle for the
 * persective camera projection. This value is
 * expressed in radians.
 *
 * @public
 * @const
 * @type {Number}
 */

export const DEFAULT_CAMERA_FIELD_OF_VIEW = radians(60)

/**
 * Default near value for the persective camera
 * projection.
 *
 * @public
 * @const
 * @type {Number}
 */

export const DEFAULT_CAMERA_NEAR = 0.01

/**
 * Default far value for the persective camera
 * projection.
 *
 * @public
 * @const
 * @type {Number}
 */

export const DEFAULT_CAMERA_FAR = 1000.0

/**
 * CameraCommand class.
 *
 * @public
 * @class CameraCommand
 * @extends Command
 */

export class CameraCommand extends MeshCommand {

  /**
   * Camera class constructor.
   *
   * @param {Context} ctx
   * @param {Object} opts
   */

  constructor(ctx, opts = {}) {
    const worldUp = new Vector(0, 1, 0)
    const target = opts.target || new Vector(0, 0, 0)
    const front = new Vector(0, 0, -1)
    const right = new Vector(1, 0, 0)
    const eye = new Vector(0, 0, 0)
    const up = new Vector(0, 0, 0)

    const projection = mat4.identity([])
    const view = mat4.identity([])

    const orientation = Object.create(DEFAULT_CAMERA_ORIENTATION_ORIGIN)

    const state = {
      viewportHeight: coalesce(opts.viewportHeight, 1),
      viewportWidth: coalesce(opts.viewportWidth, 1),
      near: coalesce(opts.near, DEFAULT_CAMERA_NEAR),
      far: coalesce(opts.far, DEFAULT_CAMERA_FAR),
      fov: coalesce(opts.fov, opts.fieldOfView, DEFAULT_CAMERA_FIELD_OF_VIEW),
    }

    const context = {
      projection({viewportWidth, viewportHeight}) {
        update({viewportWidth, viewportHeight})
        return projection
      },

      view({viewportWidth, viewportHeight}) {
        update({viewportWidth, viewportHeight})
        return view
      },

      aspect({viewportWidth, viewportHeight}) {
        return viewportWidth/viewportHeight
      },
    }

    const uniforms = { ...context }
    const render = ctx.regl({context, uniforms})

    const update = (updates) =&gt; {
      const sync = (prop) =&gt; {
        if (prop in updates) {
          state[prop] = updates[prop]
        }
      }

      // sycn properties
      sync(&apos;fov&apos;)
      sync(&apos;far&apos;)
      sync(&apos;near&apos;)
      sync(&apos;viewportWidth&apos;)
      sync(&apos;viewportHeight&apos;)

      if (&apos;position&apos; in updates) {
        vec3.copy(this.position, updates.position)
      }

      if (&apos;target&apos; in updates) {
        vec3.copy(target, updates.target)
      }

      if (&apos;rotation&apos; in updates) {
        quat.copy(this.rotation, updates.rotation)
      }

      if (&apos;orientation&apos; in updates) {
        quat.copy(orientation, updates.orientation)
      }

      const position = this.position
      const aspect = state.viewportWidth / state.viewportHeight
      const vector = new Vector(0, 0, 0)
      const near = state.near
      const far = state.far
      const fov = state.fov

      // update camera direction vectors
      vec3.set(front,
        Math.cos(orientation.x) * Math.cos(orientation.y),
        Math.sin(orientation.y),
        Math.sin(orientation.x) * Math.sin(orientation.y)
      )

      vec3.normalize(front, front)
      vec3.copy(right, vec3.normalize([], vec3.cross([], front, worldUp)))
      vec3.copy(up, vec3.normalize([], vec3.cross([], right, front)))

      // set projection
      mat4.perspective(projection, fov, aspect, near, far)

      // update transform from context if present
      if (ctx.previous &amp;&amp; ctx.previous.id != this.id) {
        mat4.copy(this.transform, mat4.multiply([], ctx.previous.transform, view))
      } else {
        mat4.copy(this.transform, view)
      }

      // update view matrix
      mat4.copy(view, this.transform)
      mat4.lookAt(view, position, target, up)
      mat4.multiply(view, view, mat4.fromQuat([], this.rotation))

      // set eye vector
      mat4.invert(scratch, view)
      vec3.set(eye, scratch[12], scratch[13], scratch[14])
      return this
    }

    super(ctx, {
      ...opts,
      draw: false,
      render(_, state, ...args) {
        if (&apos;object&apos; == typeof state) {
          update(state)
          render(state, ...args)
        } else if (&apos;function&apos; == typeof state) {
          render(state)
        }
      }
    })

    /**
     * Camera field of view value.
     *
     * @type {Number}
     */

    define(this, &apos;fov&apos;, {
      get: () =&gt; state.fov,
      set: (fov) =&gt; update({fov})
    })

    /**
     * Camera far value.
     *
     * @type {Number}
     */

    define(this, &apos;far&apos;, {
      get: () =&gt; state.far,
      set: (far) =&gt; update({far})
    })

    /**
     * Camera near value.
     *
     * @type {Number}
     */

    define(this, &apos;near&apos;, {
      get: () =&gt; state.near,
      set: (near) =&gt; update({near})
    })

    /**
     * Camera projection value.
     *
     * @type {Number}
     */

    define(this, &apos;projection&apos;, { get: () =&gt; projection })

    /**
     * Camera view matrix value.
     *
     * @type {Number}
     */

    define(this, &apos;view&apos;, { get: () =&gt; view })

    /**
     * Camera world up vector.
     *
     * @type {Vector}
     */

    define(this, &apos;worldUp&apos;, { get: () =&gt; worldUp })

    /**
     * Camera front vector.
     *
     * @type {Vector}
     */

    define(this, &apos;front&apos;, { get: () =&gt; front })

    /**
     * Camera right vector.
     *
     * @type {Vector}
     */

    define(this, &apos;right&apos;, { get: () =&gt; right })

    /**
     * Camera eye vector.
     *
     * @type {Vector}
     */

    define(this, &apos;eye&apos;, { get: () =&gt; eye })

    /**
     * Camera up vector.
     *
     * @type {Vector}
     */

    define(this, &apos;up&apos;, { get: () =&gt; up })

    /**
     * Camera lookAt target vector.
     *
     * @type {Vector}
     */

    define(this, &apos;target&apos;, { get: () =&gt; target })

    /**
     * Camera orientation vector.
     *
     * @type {Vector}
     */

    define(this, &apos;orientation&apos;, { get: () =&gt; orientation })

    /**
     * Looks at a target vector.
     *
     * @type {Number}
     */

    define(this, &apos;lookAt&apos;, {
      value(vector) {
        vec3.copy(target, vector)
        return this
      }
    })
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
